{{ define "slack.payment.title" }}
{{- if eq .Status "firing" -}}
ğŸš¨ Payment Platform Alert - {{ .CommonLabels.alertname }}
{{- else -}}
âœ… Payment Platform Alert Resolved - {{ .CommonLabels.alertname }}
{{- end -}}
{{ end }}

{{ define "slack.payment.text" }}
{{- if eq .Status "firing" -}}
*Alert Status:* ğŸ”¥ FIRING
{{- else -}}
*Alert Status:* âœ… RESOLVED
{{- end }}

*Environment:* {{ .CommonLabels.environment | default "production" }}
*Component:* {{ .CommonLabels.component }}
*Severity:* {{ .CommonLabels.severity | upper }}

{{ range .Alerts }}
---
*Summary:* {{ .Annotations.summary }}
*Description:* {{ .Annotations.description }}
*Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
{{ if .Annotations.runbook_url }}*Runbook:* <{{ .Annotations.runbook_url }}|View Runbook>{{ end }}

*Labels:*
{{ range .Labels.SortedPairs }}  â€¢ {{ .Name }}: {{ .Value }}
{{ end }}
{{ end }}

*Actions:*
â€¢ <{{ .ExternalURL }}|View Alert in Alertmanager>
â€¢ <${GRAFANA_URL}/d/performance-overview|Performance Dashboard>
â€¢ <${KIBANA_URL}|Application Logs>
{{ end }}

{{ define "slack.critical.title" }}
ğŸš¨ğŸš¨ CRITICAL ALERT - Payment Platform
{{ end }}

{{ define "slack.critical.text" }}
*ğŸ”¥ CRITICAL ALERT FIRING ğŸ”¥*

{{ range .Alerts }}
*{{ .Annotations.summary }}*
{{ .Annotations.description }}

*Component:* {{ .Labels.component }}
*Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
*Severity:* CRITICAL

{{ if .Annotations.runbook_url }}
ğŸ“‹ *Immediate Action Required:* <{{ .Annotations.runbook_url }}|Follow Runbook>
{{ end }}
{{ end }}

âš¡ *Quick Links:*
â€¢ <${GRAFANA_URL}/d/performance-overview|Performance Dashboard>
â€¢ <${PROMETHEUS_URL}|Prometheus Metrics>
â€¢ <${KIBANA_URL}|Application Logs>

ğŸ‘¥ *Escalation:* @channel @oncall-engineer
{{ end }}

{{ define "slack.security.title" }}
ğŸ”’ SECURITY ALERT - Payment Platform
{{ end }}

{{ define "slack.security.text" }}
*ğŸ”’ SECURITY ALERT*

{{ range .Alerts }}
*Event:* {{ .Annotations.summary }}
*Details:* {{ .Annotations.description }}
*Component:* {{ .Labels.component }}
*Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}

{{ if .Labels.organization_id }}*Organization:* {{ .Labels.organization_id }}{{ end }}
{{ if .Labels.user_id }}*User:* {{ .Labels.user_id }}{{ end }}
{{ if .Labels.ip_address }}*IP Address:* {{ .Labels.ip_address }}{{ end }}
{{ end }}

*ğŸš¨ Immediate Actions Required:*
1. Review security logs in Kibana
2. Check for additional suspicious activity
3. Consider blocking suspicious IPs if applicable
4. Update security team via @security-team

*Links:*
â€¢ <${KIBANA_URL}|Security Logs>
â€¢ <${GRAFANA_URL}/d/security-dashboard|Security Dashboard>
{{ end }}

{{ define "slack.performance.title" }}
âš¡ Performance Alert - Payment Platform
{{ end }}

{{ define "slack.performance.text" }}
*âš¡ Performance Issue Detected*

{{ range .Alerts }}
*Issue:* {{ .Annotations.summary }}
*Details:* {{ .Annotations.description }}
*Component:* {{ .Labels.component }}
*Metric Value:* {{ .Annotations.value | default "N/A" }}
*Threshold:* {{ .Annotations.threshold | default "N/A" }}
{{ end }}

*ğŸ“Š Performance Metrics:*
â€¢ <${GRAFANA_URL}/d/performance-overview|Performance Overview>
â€¢ <${GRAFANA_URL}/d/database-performance|Database Performance>
â€¢ <${GRAFANA_URL}/d/application-metrics|Application Metrics>

*ğŸ”§ Common Solutions:*
{{ range .Alerts }}
{{ if eq .Labels.component "memory" }}
â€¢ Check for memory leaks
â€¢ Review garbage collection logs
â€¢ Consider heap size adjustment
{{ else if eq .Labels.component "database" }}
â€¢ Review slow query logs
â€¢ Check database connection pool
â€¢ Analyze query execution plans
{{ else if eq .Labels.component "api" }}
â€¢ Check for slow endpoints
â€¢ Review application logs
â€¢ Monitor request patterns
{{ end }}
{{ end }}
{{ end }}

{{ define "slack.database.title" }}
ğŸ—„ï¸ Database Alert - Payment Platform
{{ end }}

{{ define "slack.database.text" }}
*ğŸ—„ï¸ Database Issue*

{{ range .Alerts }}
*Issue:* {{ .Annotations.summary }}
*Details:* {{ .Annotations.description }}
*Database Component:* {{ .Labels.component }}
{{ if .Labels.query_type }}*Query Type:* {{ .Labels.query_type }}{{ end }}
{{ if .Annotations.duration_ms }}*Duration:* {{ .Annotations.duration_ms }}ms{{ end }}
{{ end }}

*ğŸ” Investigation Steps:*
1. Check database performance metrics
2. Review slow query logs
3. Analyze connection pool status
4. Check for lock contention

*ğŸ“Š Database Dashboards:*
â€¢ <${GRAFANA_URL}/d/database-performance|Database Performance>
â€¢ <${GRAFANA_URL}/d/postgres-overview|PostgreSQL Overview>
â€¢ <${KIBANA_URL}|Database Logs>
{{ end }}

{{ define "slack.payment.title" }}
ğŸ’³ Payment System Alert
{{ end }}

{{ define "slack.payment.text" }}
*ğŸ’³ Payment System Issue*

{{ range .Alerts }}
*Issue:* {{ .Annotations.summary }}
*Details:* {{ .Annotations.description }}
*Payment Component:* {{ .Labels.component }}
{{ if .Labels.organization_id }}*Organization:* {{ .Labels.organization_id }}{{ end }}
{{ if .Annotations.transaction_id }}*Transaction:* {{ .Annotations.transaction_id }}{{ end }}
{{ end }}

*ğŸ’° Payment Impact Assessment:*
â€¢ Check payment success rates
â€¢ Review Stripe webhook status
â€¢ Monitor transaction volumes

*ğŸ”§ Immediate Actions:*
1. Verify Stripe connectivity
2. Check webhook endpoint health
3. Review payment processing logs
4. Contact Stripe support if needed

*ğŸ“Š Payment Dashboards:*
â€¢ <${GRAFANA_URL}/d/payment-overview|Payment Overview>
â€¢ <${STRIPE_DASHBOARD_URL}|Stripe Dashboard>
â€¢ <${KIBANA_URL}|Payment Logs>

ğŸ‘¥ *Escalation:* @payment-team
{{ end }}

{{ define "email.subject" }}
{{ if eq .Status "firing" }}
ğŸš¨ {{ .CommonLabels.severity | upper }} Alert: {{ .CommonLabels.alertname }}
{{ else }}
âœ… Resolved: {{ .CommonLabels.alertname }}
{{ end }}
{{ end }}

{{ define "email.html" }}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Payment Platform Alert</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .alert-header { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .critical { border-left: 5px solid #dc3545; }
        .warning { border-left: 5px solid #ffc107; }
        .info { border-left: 5px solid #17a2b8; }
        .alert-details { background-color: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .metric-value { font-weight: bold; color: #dc3545; }
        .timestamp { color: #6c757d; font-size: 0.9em; }
        .actions { margin-top: 20px; }
        .button { background-color: #007bff; color: white; padding: 10px 15px; text-decoration: none; border-radius: 3px; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="alert-header {{ .CommonLabels.severity }}">
        <h2>
            {{ if eq .Status "firing" }}ğŸš¨ Alert Firing{{ else }}âœ… Alert Resolved{{ end }}
            - Payment Platform
        </h2>
        <p><strong>Alert:</strong> {{ .CommonLabels.alertname }}</p>
        <p><strong>Component:</strong> {{ .CommonLabels.component }}</p>
        <p><strong>Severity:</strong> {{ .CommonLabels.severity | upper }}</p>
        <p class="timestamp"><strong>Time:</strong> {{ .Alerts.First.StartsAt.Format "2006-01-02 15:04:05 UTC" }}</p>
    </div>

    {{ range .Alerts }}
    <div class="alert-details">
        <h3>{{ .Annotations.summary }}</h3>
        <p>{{ .Annotations.description }}</p>

        {{ if .Annotations.value }}
        <p><strong>Current Value:</strong> <span class="metric-value">{{ .Annotations.value }}</span></p>
        {{ end }}

        {{ if .Annotations.threshold }}
        <p><strong>Threshold:</strong> {{ .Annotations.threshold }}</p>
        {{ end }}

        <h4>Labels:</h4>
        <ul>
        {{ range .Labels.SortedPairs }}
            <li><strong>{{ .Name }}:</strong> {{ .Value }}</li>
        {{ end }}
        </ul>

        {{ if .Annotations.runbook_url }}
        <p><strong>Runbook:</strong> <a href="{{ .Annotations.runbook_url }}">{{ .Annotations.runbook_url }}</a></p>
        {{ end }}
    </div>
    {{ end }}

    <div class="actions">
        <h3>Quick Actions:</h3>
        <a href="${GRAFANA_URL}/d/performance-overview" class="button">Performance Dashboard</a>
        <a href="${PROMETHEUS_URL}" class="button">Prometheus Metrics</a>
        <a href="${KIBANA_URL}" class="button">Application Logs</a>
        <a href="{{ .ExternalURL }}" class="button">View in Alertmanager</a>
    </div>

    <hr>
    <p style="color: #6c757d; font-size: 0.9em;">
        This alert was generated by the Payment Platform monitoring system.
        If you believe this is a false positive, please check the alert configuration.
    </p>
</body>
</html>
{{ end }}